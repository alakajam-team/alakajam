{% extends "base.html" %}
{% import "event/event.macros.html" as eventMacros with context %}
{% import "macros/form.macros.html" as formMacros with context  %}
{% import "post/post.macros.html" as postMacros with context  %}
{% import "macros/jumbotron.macros.html" as jumbotronMacros with context  %}
{% import "user/user.macros.html" as userMacros with context %}

{% block styles %}
<style type="text/css">
.main-action-banners .action-banner {
  min-height: 110px;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
}

</style>
{% endblock %}

{% block body %}

<div class="container">
  <h1>{{ event.get('title') }} dashboard</h1>

  {{ formMacros.alerts(alerts) }}

  <div class="row mt-4">
    <div class="col-md-3 col-12">
      <h2 class="mb-2">Useful links</h2>

      <div class="list-group">
        {% set featuredLinks = event.related('details').get('links') %}
        {% for featuredLink in featuredLinks %}
          <a class="list-group-item shortcut" href="{{ featuredLink.link }}">
            <h4>
              <span class="shortcut__icon"><span class="fas {{ featuredLink.icon }}"></span></span>
              <span class="shortcut__title">{{ featuredLink.title }}</span>
            </h4>
          </a>
        {% endfor %}
      </div>
      
      <h2 class="mb-2 mt-4">Event stats</h2>

      <div class="card card-body">
        {{ jumbotronMacros.statsCounters(event) }}
      </div>
    </div>
    <div class="col-md-9 col-12">
      <div class="mb-3">
        <h2><span class="fa fa-gamepad"></span> Entry</h2>
    
        <div class="row main-action-banners">
          
          <div class="col-lg-7">
            <h3>As jammer</h3>
            {{ eventMacros.eventShortcutMyEntry(user, event, entry, { noTitle: true }) }}
          </div>
          <div class="col-lg-5">
            <h3>As streamer</h3>

            <form method="post" class="action-banner text-center">
              {{ csrfToken() | safe }}
              
              {% if eventParticipation.isStreamer %}
                <p>You are entering the event as a streamer!</p>
                {% set socialLinks = user.related('details').get('social_links') %}
                {% if socialLinks.twitch %}
                  <span class="alert alert-light">
                    {{ userMacros.twitchLink(user) }}<br />
                    {% if eventParticipation.streamerStatus === "requested" %}
                      <span class="badge badge-warning">
                        Pending approbation
                        {{ formMacros.tooltip('The mods make a simple check, usually within 24 hours, to filter possible spammers and multiple accounts.') }}
                      </span>
                    {% elseif eventParticipation.streamerStatus === "approved" %}
                      <span class="badge badge-success">Approved</span>
                    {% endif %}
                  </span>
                {% else %}
                  <span class="alert alert-warning"><span class="fa fa-exclamation-triangle"></span> Unknown Twitch channel</span>
                {% endif %}
                <a href="{{ routeUrl(event, 'event', 'dashboard-streamer-preferences') }}" class="btn btn-primary">Manage streamer settings</a>
              {% elseif event.get("status_entry") !== 'closed' %}
                <input type="hidden" name="is-streamer" value="true" />
                <button type="submit" name="streamer-preferences" class="btn btn-primary btn-lg">
                  <span class="fas fa-video"></span>
                  Enter as streamer
                </button>
              {% else %}
                <p>Streamer entries are now closed.</p>
                <p><a href="/events" class="btn btn-secondary">Explore our upcoming events</a></p>
              {% endif %}
            </form>
          </div>
        </div>

      </div>
    
      {% if event.get('status_themes') !== 'disabled' %}
      <div>
        <h2><span class="fa fa-lightbulb"></span> Themes</h2>
        
        {% if event.get('status_theme') === 'off' %}
        <div class="card card-body">
          <h4>Theme submissions are not open yet.</h4>
        </div>
        {% else %}
          <a href="{{ routeUrl(event, 'event', 'themes') }}" class="btn btn-primary">Browse themes</a>
        {% endif %}
      </div>
      {% endif %}
    
      <div class="mt-4">
        <h2><span class="fa fa-newspaper"></span> Blog posts</h2>
    
        <p class="mt-3">{{ eventMacros.eventShortcutMyPost(user, event, latestPost, { buttonsOnly: true }) }}</p>
    
        {% if posts.length === 0 %}
          <div class="card card-body">
            <h4>You don't have posts on this event yet.</h4>
            {% if event.get('status_entry') === 'off' %}
              <p>Make a blog post to present yourself and share your plans for the jam!</p>
            {% elseif entry %}
              <p>Telling your experience with a post is a good way to share what you learnt and exchange impressions!</p>
            {% endif %}
          </div>
        {% endif %}
    
        <div class="mt-4">
        {% for post in posts %}
          {{ postMacros.post(post, { hideBody: true, smallTitle: true, readingUser: user, readingUserLikes: userLikes }) }}
        {% endfor %}
        </div>
      </div>
    
      <div class="mt-5">
        {% if eventParticipation.isStreamer %}
        <form method="post" class="d-inline">
          {{ csrfToken() | safe }}
          <input type="hidden" name="is-streamer" value="false" />
          <button type="submit" name="streamer-preferences" class="btn btn-danger" onclick="return confirm('Cancel participation as streamer? You can return at any time until the end of jam.')">
            Cancel participation as streamer
          </button>
        </form>
        {% endif %}
        <a href="{{ routeUrl(event, 'event', 'join') }}?leave" class="btn btn-danger" onclick="return confirm('Leave the event? You can return at any time.')">
          Leave event
        </a>
      </div>
    </div>
  </div>

</div>

{% endblock %}
